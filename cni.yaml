---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: flannel
rules:
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
  - apiGroups:
      - ""
    resources:
      - nodes
    verbs:
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - nodes/status
    verbs:
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
  - kind: ServiceAccount
    name: flannel
    namespace: kube-system
- apiVersion: v1
kind: ServiceAccount
metadata:
  name: flannel
  namespace: kube-system
---
apiVersion: v1
data:
  cni-conf.json: |
      {
        "name": "cbr0",
        "cniVersion": "0.3.1",
        "plugins": [
          {
            "type": "flannel",
            "delegate": {
              "hairpinMode": true,
              "isDefaultGateway": true
            }
          },
          {
            "type": "portmap",
            "capabilities": {
              "portMappings": true
            }
          }
        ]
      }
  net-conf.json: |-
      {
        "Network": "10.244.0.0/16",
        "Backend": {
          "Type": "vxlan",
          "Port": 4789
        }
      }
kind: ConfigMap
metadata:
  labels:
      k8s-app: flannel
      tier: node
  name: kube-flannel-cfg
  namespace: kube-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
      k8s-app: flannel
      tier: node
  name: kube-flannel
  namespace: kube-system
spec:
  selector:
      matchLabels:
          k8s-app: flannel
          tier: node
  template:
      metadata:
          labels:
              k8s-app: flannel
              tier: node
      spec:
          containers:
              - args:
                  - --ip-masq
                  - --kube-subnet-mgr
                command:
                  - /opt/bin/flanneld
                env:
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                          fieldPath: metadata.name
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                          fieldPath: metadata.namespace
                  - name: POD_IP
                    valueFrom:
                      fieldRef:
                          fieldPath: status.podIP
                image: registry.dev-pau1209.staging.anywhere.navify.com/ghcr.io/siderolabs/flannel:v0.19.1
                name: kube-flannel
                securityContext:
                  capabilities:
                      add:
                          - NET_ADMIN
                          - NET_RAW
                  privileged: true
                volumeMounts:
                  - mountPath: /run/flannel
                    name: run
                  - mountPath: /etc/kube-flannel/
                    name: flannel-cfg
          hostNetwork: true
          initContainers:
              - args:
                  - -f
                  - /etc/kube-flannel/cni-conf.json
                  - /etc/cni/net.d/10-flannel.conflist
                command:
                  - cp
                image: registry.dev-pau1209.staging.anywhere.navify.com/ghcr.io/siderolabs/flannel:v0.19.1
                name: install-config
                volumeMounts:
                  - mountPath: /etc/cni/net.d
                    name: cni
                  - mountPath: /etc/kube-flannel/
                    name: flannel-cfg
              - command:
                  - /install-cni.sh
                image: registry.dev-pau1209.staging.anywhere.navify.com/ghcr.io/siderolabs/install-cni:v1.2.0
                name: install-cni
                volumeMounts:
                  - mountPath: /host/opt/cni/bin/
                    name: host-cni-bin
          serviceAccountName: flannel
          tolerations:
              - effect: NoSchedule
                operator: Exists
              - effect: NoExecute
                operator: Exists
          volumes:
              - hostPath:
                  path: /run/flannel
                name: run
              - hostPath:
                  path: /etc/cni/net.d
                name: cni
              - configMap:
                  name: kube-flannel-cfg
                name: flannel-cfg
              - hostPath:
                  path: /opt/cni/bin
                name: host-cni-bin
  updateStrategy:
      rollingUpdate:
          maxUnavailable: 1
      type: RollingUpdate
